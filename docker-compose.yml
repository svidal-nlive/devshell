services:
  devshell:
    # Pull prebuilt image from GitHub Container Registry
    # No local build needed - image is built by GitHub Actions
    image: ghcr.io/${GITHUB_USERNAME}/devshell:latest
    
    container_name: devshell
    hostname: devshell
    restart: unless-stopped
    
    environment:
      # User configuration
      - USERNAME=${USERNAME:-msn0624c}
      - USER_UID=${USER_UID:-1026}
      - USER_GID=${USER_GID:-100}
      - ADMIN_GID=${ADMIN_GID:-101}
      
      # Docker socket GID (must match host)
      # Get with: stat -c %g /var/run/docker.sock
      - DOCKER_GID=${DOCKER_GID:-999}
    
    volumes:
      # SSH keys (authorized_keys must be in this directory)
      - ./ssh:/home/${USERNAME:-msn0624c}/.ssh:ro
      
      # Docker socket passthrough for Docker CLI access
      - /var/run/docker.sock:/var/run/docker.sock
      
      # Optional: Mount workspace directories
      # - /volume1/docker:/workspace/docker:ro
    
    ports:
      # SSH on port 2222 (maps to external port 22 via router)
      - "2222:22"
    
    networks:
      - proxy
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  proxy:
    external: true
